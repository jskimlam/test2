<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Global SM Status (Full 122 Sites) | Made by LAM</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #0A2647; --accent: #1597BB; --risk: #C0392B; --trouble: #1A1A1B; --bg: #F0F5F9; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        #layout { display: flex; height: 100vh; width: 100vw; }
        #map { flex-grow: 1; height: 100%; background: #DAEAF1; z-index: 1; }
        #sidebar { width: 450px; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        
        .header { background: var(--primary); color: white; padding: 20px; }
        .global-cap { background: var(--accent); padding: 15px 20px; color: white; border-bottom: 2px solid rgba(0,0,0,0.1); }
        
        #list-container { flex-grow: 1; overflow-y: auto; background: var(--bg); }
        
        /* ÏÑπÏÖò Ìó§Îçî (Risk vs Regions) */
        .section-title { background: var(--trouble); color: white; padding: 10px 15px; font-size: 0.85rem; font-weight: bold; letter-spacing: 1px; }
        .section-title.blue { background: var(--primary); }

        /* ÏïÑÏΩîÎîîÏñ∏ Ïä§ÌÉÄÏùº */
        .group-header { padding: 12px 15px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .region-header { background: #cbdceb; color: var(--primary); }
        .country-header { background: #eef2f5; color: #444; padding-left: 30px; font-size: 0.9rem; }
        
        .collapsible-content { display: none; }
        .open > .collapsible-content { display: block; }

        .plant-card {
            padding: 10px 15px 10px 45px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; font-size: 0.8rem; background: white;
        }
        .plant-card:hover { background: #f0f7ff; }
        .plant-card.issue { border-left: 5px solid var(--trouble); }
        .badge { font-size: 0.65rem; padding: 2px 5px; border-radius: 3px; color: white; background: var(--accent); float: right; }
        .badge.black { background: var(--trouble); }
        .badge.red { background: var(--risk); }
    </style>
</head>
<body>
<div id="layout">
    <div id="sidebar">
        <div class="header">
            <h1 style="margin:0; font-size:1.1rem;">Global SM Status (122 Sites)</h1>
            <p style="margin:5px 0 0 0; font-size:0.7rem; opacity:0.7;">Lotte Merged | Individual Line Tracking</p>
        </div>
        <div class="global-cap">
            <span style="font-size:0.75rem;">Total Capacity Tracking</span><br>
            <strong id="global-val">0</strong> <small>K MT/Y</small>
        </div>
        <div id="list-container">
            <div class="section-title">‚ö†Ô∏è SUPPLY RISKS (TROUBLE / MAINTENANCE)</div>
            <div id="risk-list"></div>
            
            <div class="section-title blue">üåê ALL PLANTS BY REGION</div>
            <div id="region-list"></div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl: false}).setView([25, 40], 3);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    fetch('data.json').then(r => r.json()).then(data => {
        const plants = data.plants;
        document.getElementById('global-val').innerText = plants.reduce((s, p) => s + p.capacity, 0).toLocaleString();

        const nested = {};
        const riskPlants = plants.filter(p => p.status !== 'Normal');

        plants.forEach(p => {
            // ÏßÄÎèÑ ÎßàÏª§ ÏÉùÏÑ±
            const isRisk = p.status !== 'Normal';
            const color = isRisk ? '#1A1A1B' : '#1597BB';
            const m = L.circleMarker([p.lat, p.lng], {
                radius: Math.sqrt(p.capacity) * 1.3, fillColor: color, color: '#fff', weight: 1, fillOpacity: 0.8
            }).addTo(map);
            m.bindPopup(`<b>${p.company}</b><br>Loc: ${p.location}<br>Capa: ${p.capacity}K<br>Status: <b>${p.status}</b>`);
            p._m = m;

            // ÏßÄÏó≠Î≥Ñ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ìôî
            if (!nested[p.region]) nested[p.region] = { capa: 0, countries: {} };
            if (!nested[p.region].countries[p.country]) nested[p.region].countries[p.country] = { capa: 0, plants: [] };
            nested[p.region].capa += p.capacity;
            nested[p.region].countries[p.country].capa += p.capacity;
            nested[p.region].countries[p.country].plants.push(p);
        });

        // 1. Î¶¨Ïä§ÌÅ¨ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
        const riskContainer = document.getElementById('risk-list');
        riskPlants.sort((a,b) => b.capacity - a.capacity).forEach(p => {
            const card = document.createElement('div');
            card.className = 'plant-card issue';
            card.innerHTML = `<span class="badge black">${p.status}</span><b>${p.company}</b><br><small>${p.country} | ${p.capacity}K MT</small>`;
            card.onclick = () => { map.flyTo([p.lat, p.lng], 9); p._m.openPopup(); };
            riskContainer.appendChild(card);
        });

        // 2. ÏßÄÏó≠Î≥Ñ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ (ÏïÑÏΩîÎîîÏñ∏)
        const regionContainer = document.getElementById('region-list');
        Object.entries(nested).sort((a,b)=>b[1].capa - a[1].capa).forEach(([rName, rData]) => {
            const rDiv = document.createElement('div');
            rDiv.className = 'region-group';
            rDiv.innerHTML = `<div class="group-header region-header" onclick="this.parentElement.classList.toggle('open')">
                <span>${rName}</span><span>${rData.capa.toLocaleString()}K</span></div>
                <div class="collapsible-content"></div>`;
            
            const countryList = rDiv.querySelector('.collapsible-content');
            Object.entries(rData.countries).sort((a,b)=>b[1].capa - a[1].capa).forEach(([cName, cData]) => {
                const cDiv = document.createElement('div');
                cDiv.className = 'country-item';
                cDiv.innerHTML = `<div class="group-header country-header" onclick="this.parentElement.classList.toggle('open')">
                    <span>${cName}</span><span>${cData.capa.toLocaleString()}K</span></div>
                    <div class="collapsible-content"></div>`;
                
                const plantList = cDiv.querySelector('.collapsible-content');
                cData.plants.forEach(p => {
                    const pCard = document.createElement('div');
                    const isRisk = p.status !== 'Normal';
                    pCard.className = `plant-card ${isRisk ? 'issue' : ''}`;
                    pCard.innerHTML = `<span class="badge ${isRisk?'black':''}">${p.status}</span><b>${p.company}</b><br><small>${p.capacity}K MT</small>`;
                    pCard.onclick = (e) => { e.stopPropagation(); map.flyTo([p.lat, p.lng], 9); p._m.openPopup(); };
                    plantList.appendChild(pCard);
                });
                countryList.appendChild(cDiv);
            });
            regionContainer.appendChild(rDiv);
        });
    });
</script>
</body>
</html>
