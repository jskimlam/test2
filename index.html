<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEA Shutdown Dashboard 2026</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í™”ë©´ UI (ë¼ì´íŠ¸ í…Œë§ˆ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Arial', sans-serif;
  background: #f0f2f5; color: #1a2a3a;
  min-height: 100vh; padding: 10px; font-size: 12px;
}

/* í—¤ë” */
.hdr {
  display: flex; align-items: center; justify-content: space-between;
  background: linear-gradient(135deg, #1A5276, #1F618D);
  border: 1px solid #1A5276; border-radius: 9px;
  padding: 10px 15px; margin-bottom: 9px; gap: 8px; flex-wrap: wrap;
}
.hdr-title { font-size: 15px; font-weight: 700; color: #fff; }
.hdr-sub   { font-size: 10px; color: #AED6F1; margin-top: 2px; }
.hdr-btns  { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

/* ë²„íŠ¼ */
.btn {
  padding: 6px 12px; border-radius: 5px; font-size: 11px;
  font-weight: 700; cursor: pointer; border: none; white-space: nowrap;
  transition: filter 0.15s;
}
.btn:hover    { filter: brightness(1.1); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; filter: none; }
.btn-green { background: #1e8449; color: #fff; font-size: 12px; padding: 7px 15px; }
.btn-red   { background: #c0392b; color: #fff; }
.btn-grey  { background: #e8ecf0; color: #34495e; border: 1px solid #ccd0d5; }

/* ì»¨íŠ¸ë¡¤ ë°” */
.ctrl-bar {
  display: flex; align-items: center; gap: 10px;
  background: #fff; border: 1px solid #d5dae0;
  border-radius: 7px; padding: 7px 13px; margin-bottom: 8px; flex-wrap: wrap;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.ctrl-lbl { font-size: 10px; color: #7f8c8d; white-space: nowrap; font-weight: 600; }

/* ì›” ë²„íŠ¼ */
.m-btns { display: flex; gap: 3px; flex-wrap: wrap; align-items: center; }
.m-btn {
  padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
  cursor: pointer; border: 1px solid #ccd0d5; background: #f8f9fa; color: #4a6078;
  transition: all 0.12s; user-select: none;
}
.m-btn:hover { border-color: #2980b9; background: #eaf4fb; color: #1a5276; }
.m-btn.on    { background: #2980b9; border-color: #1a6ea0; color: #fff; font-weight: 700; }
.m-btn-all {
  padding: 4px 9px; border-radius: 4px; font-size: 11px; font-weight: 700;
  cursor: pointer; border: 1px solid #ccd0d5; background: #eaf4fb; color: #1a5276;
}
.m-btn-all:hover { background: #d4e9f7; }

/* í‘œì‹œ í† ê¸€ */
.vtgl {
  padding: 4px 9px; border-radius: 4px; font-size: 11px; font-weight: 600;
  cursor: pointer; border: 1px solid #ccd0d5; background: #f8f9fa; color: #4a6078;
  transition: all 0.12s;
}
.vtgl.on { background: #2980b9; border-color: #1a6ea0; color: #fff; font-weight: 700; }

/* í†µê³„ */
.stat-bar { display: flex; gap: 6px; margin-bottom: 7px; flex-wrap: wrap; }
.sbadge {
  background: #fff; border: 1px solid #d5dae0; border-radius: 5px;
  padding: 4px 10px; font-size: 10px; color: #5a6a7a;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.sbadge b { color: #1A5276; }
.sbadge span { font-weight: 700; color: #1A5276; font-size: 11px; }

/* í’ˆëª© ì„¹ì…˜ */
.prod-sec {
  margin-bottom: 6px; border: 1px solid #d5dae0;
  border-radius: 7px; overflow: hidden;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
}
/* í’ˆëª© ì„¹ì…˜ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œê±° - ëª¨ë“  í–‰ í‘œì‹œ */
.tbl-wrap { overflow-x: auto; background: #fff; }

/* ìº˜ë¦°ë” í…Œì´ë¸” (ë¼ì´íŠ¸) */
/* table-layout:fixed â†’ ëª¨ë“  í’ˆëª© Company/Country/Cap ì—´ ë„ˆë¹„ ë™ì¼ ê³ ì • */
.cal-tbl { border-collapse: collapse; font-size: 10px; width: 100%; table-layout: fixed; }
.col-co  { width: 140px; } /* Company ì—´ ê³ ì • ë„ˆë¹„ */
.col-loc { width: 60px;  } /* Country ì—´ ê³ ì • ë„ˆë¹„ */
.col-cap { width: 36px;  } /* Capacity ì—´ ê³ ì • ë„ˆë¹„ */
.th-info {
  background: #1A5276; color: #fff; font-weight: 700; font-size: 10px;
  text-align: center; padding: 4px 3px; border: 1px solid #1a4a6a;
  position: sticky; top: 0; left: 0; z-index: 20; white-space: nowrap;
}
.th-mon {
  font-weight: 700; font-size: 10px; text-align: center; padding: 5px 2px;
  border: 1px solid #bfc9ca; position: sticky; top: 0; z-index: 10;
  white-space: normal; line-height: 1.4; vertical-align: middle;
}
.th-wk {
  font-weight: 600; font-size: 8px; text-align: center; padding: 2px 1px;
  border: 1px solid #d5d8dc; min-width: 24px; max-width: 26px;
  white-space: nowrap; line-height: 1.3; position: sticky; top: 40px; z-index: 10;
  background: #f4f6f7; color: #555;
}
.th-loss {
  font-weight: 700; font-size: 8px; text-align: center; padding: 2px 3px;
  border: 1px solid #d5d8dc; min-width: 45px; white-space: nowrap;
  position: sticky; top: 26px; z-index: 10; background: #fef9e7; color: #7d6608;
}
.cur-wk-th {
  background: #fef3cd !important; color: #e67e22 !important;
  border-left: 2px solid #e67e22 !important; border-right: 2px solid #e67e22 !important;
}
.cal-tbl td { border: 1px solid #e0e4e8; padding: 2px 3px; }
.td-co {
  position: sticky; left: 0; z-index: 5; background: #eaf2fb;
  color: #1a2a3a; font-weight: 600;
  width: 140px; white-space: nowrap; font-size: 8px;
  overflow: hidden; text-overflow: ellipsis; max-width: 140px;
}
.td-loc { color: #34495e; font-size: 8px; width: 60px; white-space: nowrap; font-weight: 500; overflow: hidden; text-overflow: ellipsis; }
.td-cap { text-align: right; color: #1a7a5e; font-weight: 700; width: 36px; white-space: nowrap; font-size: 8px; }
.td-wk  { min-width: 24px; max-width: 26px; text-align: center; padding: 1px; }
.td-loss { text-align: right; font-size: 9px; padding: 2px 4px; min-width: 42px; white-space: nowrap; }
.tr-grp td {
  background: #2C3E50 !important; color: #fff; font-weight: 700; font-size: 9px;
  padding: 3px 7px; border-top: 1px solid #566573; white-space: nowrap;
}
.tr-e .td-co { background: #eaf2fb; }
.tr-e td:not(.td-co) { background: #f4f6f7; }
.tr-o .td-co { background: #f8fbfd; }
.tr-o td:not(.td-co) { background: #ffffff; }

/* Loss í•©ê³„ í–‰ */
.tr-loss td {
  background: #fdfefe !important; font-weight: 700; font-size: 9px;
  padding: 3px 4px; border-top: 2px solid #d5d8dc;
}

/* ë²”ë¡€ */
.legend {
  display: flex; align-items: center; gap: 12px; padding: 6px 14px;
  font-size: 9px; color: #5a6a7a; background: #fff;
  border: 1px solid #d5dae0; flex-wrap: wrap; margin-top: 5px; border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.leg-i { display: flex; align-items: center; gap: 3px; }
.leg-d { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }

/* ë¡œë”© / í† ìŠ¤íŠ¸ */
.loading {
  display: flex; align-items: center; justify-content: center;
  height: 70px; font-size: 12px; color: #2980b9;
}
.spinner {
  width: 18px; height: 18px; border: 2px solid #d5dae0; border-top-color: #2980b9;
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }
#toast {
  position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
  background: #1e8449; color: #fff; padding: 8px 18px; border-radius: 6px;
  font-size: 12px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  opacity: 0; transition: opacity 0.3s; z-index: 9999; pointer-events: none;
}
#toast.show { opacity: 1; }
#toast.warn { background: #ca6f1e; }
#toast.err  { background: #c0392b; }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: #f0f2f5; }
::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 2px; }

/* PNG ìº¡ì²˜ ì „ìš© ìˆ¨ê¹€ */
#xl-clone {
  position: fixed; left: -99999px; top: 0;
  background: #fff; display: inline-block; z-index: -1;
}
</style>
</head>
<body>

<!-- í—¤ë” -->
<div class="hdr">
  <div>
    <div class="hdr-title">ğŸ­ NEA Plant Shutdown Calendar 2026</div>
    <div class="hdr-sub">SM Â· AN Â· BD Â· BPA Â· MMA ì •ê¸°ë³´ìˆ˜ / ê°€ë™ì •ì§€ í˜„í™© (NEA Region)</div>
  </div>
  <div class="hdr-btns">
    <button class="btn btn-grey"  onclick="scrollCurWeek()">ğŸ“ í˜„ì¬ì£¼ì°¨</button>
    <button class="btn btn-red"   onclick="loadData()">ğŸ”„ ê°±ì‹ </button>
    <button class="btn btn-green" id="btn-png" onclick="downloadPNG()">ğŸ“· PNG ì €ì¥</button>
  </div>
</div>

<!-- ì»¨íŠ¸ë¡¤ -->
<div class="ctrl-bar">
  <span class="ctrl-lbl">ğŸ“… ì›”</span>
  <div class="m-btns" id="m-btns">
    <button class="m-btn-all" onclick="toggleAllM()">ì „ì²´</button>
  </div>
  <div style="width:1px;height:20px;background:#2a3d65;"></div>
  <span class="ctrl-lbl">ğŸ‘ï¸</span>
  <div style="display:flex;gap:3px;">
    <div class="vtgl on" id="vt-s" onclick="setView('shutdown')">ì •ì§€ë§Œ</div>
    <div class="vtgl"    id="vt-a" onclick="setView('all')">ì „ì²´</div>
  </div>
</div>

<!-- í†µê³„ -->
<div class="stat-bar" id="stat-bar"></div>

<!-- SM / AN / BD / BPA / MMA ì„¹ì…˜ -->
<div id="sections">
  <div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>

<!-- ë²”ë¡€ -->
<div class="legend">
  <div class="leg-i"><div class="leg-d" style="background:#F1C40F;"></div>ì •ê¸°ë³´ìˆ˜</div>
  <div class="leg-i"><div class="leg-d" style="background:#E74C3C;"></div>ê¸´ê¸‰/ë¹„ê³„íš ì •ì§€</div>
  <div class="leg-i"><div class="leg-d" style="background:#3498DB;"></div>ì˜ˆì • ë³´ìˆ˜</div>
  <div class="leg-i" style="margin-left:8px;color:#f39c12;">â”‚ í˜„ì¬ì£¼ì°¨</div>
</div>

<div id="xl-clone"></div>
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var YEAR = 2026;
var MN   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
var M_DK = {1:'#1a2d40',2:'#1c2d38',3:'#1a3028',4:'#2c2a10',5:'#281a30',6:'#1a2530',
            7:'#1a2830',8:'#2c1a1a',9:'#1a2c20',10:'#292810',11:'#221828',12:'#1a2430'};
var M_XL = {1:'#D6E4F0',2:'#FDEBD0',3:'#D5F5E3',4:'#FCF3CF',5:'#E8DAEF',6:'#D6EAF8',
            7:'#EAF4FF',8:'#FDEDEC',9:'#E9F7EF',10:'#FEF9E7',11:'#F5EEF8',12:'#EBF5FB'};
var PRODS = [
  { key:'SM',  icon:'SM',  hdColor:'#1A5276', hdBg:'#154360', secColor:'#2e6bc4' },
  { key:'AN',  icon:'AN',  hdColor:'#145A32', hdBg:'#0E4024', secColor:'#1e8449' },
  { key:'BD',  icon:'BD',  hdColor:'#6E2F1A', hdBg:'#4A1F12', secColor:'#ca6f1e' },
  { key:'BPA', icon:'BPA', hdColor:'#4A235A', hdBg:'#2E1339', secColor:'#8e44ad' },
  { key:'MMA', icon:'MMA', hdColor:'#1A4F72', hdBg:'#0E2D40', secColor:'#1a7fa8' }
];

var allData  = {};
var viewMode = 'shutdown';
var weekMeta = buildWeekMeta();
var isIOS    = /iPad|iPhone|iPod/.test(navigator.userAgent);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() { buildMonthBtns(); loadData(); };

function buildMonthBtns() {
  var c = document.getElementById('m-btns');
  var now = new Date().getMonth() + 1;
  for (var m = 1; m <= 12; m++) {
    var b = document.createElement('button');
    b.className   = 'm-btn' + (m === now ? ' on' : '');
    b.dataset.m   = m;
    b.textContent = m + 'ì›”';
    b.onclick = (function(btn){ return function(){ btn.classList.toggle('on'); renderAll(); }; })(b);
    c.appendChild(b);
  }
}

function toggleAllM() {
  var btns  = document.querySelectorAll('.m-btn');
  var anyOn = Array.from(btns).some(function(b){ return b.classList.contains('on'); });
  btns.forEach(function(b){ anyOn ? b.classList.remove('on') : b.classList.add('on'); });
  renderAll();
}

function getSelMonths() {
  return Array.from(document.querySelectorAll('.m-btn.on'))
    .map(function(b){ return parseInt(b.dataset.m); })
    .sort(function(a,b){ return a-b; });
}

function setView(v) {
  viewMode = v;
  document.getElementById('vt-s').classList.toggle('on', v === 'shutdown');
  document.getElementById('vt-a').classList.toggle('on', v === 'all');
  renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë°ì´í„° ë¡œë“œ (GAS fetch ë°©ì‹)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var GAS_URL = 'https://script.google.com/macros/s/AKfycbx0XjMWwuPNBzLw8DXkusr1lo34cbzYZyKBcmdYffatqXEM3e0P2dv15G0edCdopfOm/exec';

function loadData() {
  document.getElementById('sections').innerHTML =
    '<div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>';

  fetch(GAS_URL + '?action=getDashboardData&t=' + new Date().getTime())
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(d) {
      if (d.error) throw new Error(d.error);
      allData = d;
      renderAll();
    })
    .catch(function(e) {
      document.getElementById('sections').innerHTML =
        '<div class="loading" style="color:#e74c3c;">âŒ ì˜¤ë¥˜: ' + e.message + '</div>';
    });
}

function renderAll() { renderStats(); renderSections(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í†µê³„ ë±ƒì§€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
  var months = getSelMonths();
  var html   = '';
  PRODS.forEach(function(p) {
    var rows  = filterRows(allData[p.key] || [], months);
    var total = (allData[p.key] || []).length;
    var shut  = rows.filter(function(r){ return r.weekColors && r.weekColors.some(Boolean); }).length;
    var loss  = calcTotalLoss(rows, months);
    var totCap = (allData[p.key] || []).reduce(function(s,r){ return s+(r.capacity||0); },0);
    var lossRate = totCap > 0 ? (loss / totCap * 100).toFixed(1) : '0.0';
    html += '<div class="sbadge"><b>' + p.key + '</b> '
          + 'ì •ì§€:<span>' + shut + '</span>ê°œ / NEA:<span>' + total + '</span>ê°œ'
          + ' | Loss:<span>' + loss.toFixed(0) + '</span>kt'
          + ' (<span>' + lossRate + '</span>%)</div>';
  });
  document.getElementById('stat-bar').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í™”ë©´ ì„¹ì…˜ ë Œë”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSections() {
  var months    = getSelMonths();
  var showWeeks = months.length > 0
    ? weekMeta.filter(function(w){ return months.indexOf(w.month) !== -1; })
    : weekMeta;
  var curWeek   = getCurWeek();
  var html      = '';

  PRODS.forEach(function(p) {
    var rows     = filterRows(allData[p.key] || [], months);
    var shutCnt  = rows.filter(function(r){ return r.weekColors&&r.weekColors.some(Boolean); }).length;
    var totCap   = (allData[p.key]||[]).reduce(function(s,r){return s+(r.capacity||0);},0);

    html += '<div class="prod-sec" style="border-color:' + p.secColor + '88;">';
    html += '<div class="tbl-wrap">'
          + buildDarkTable(rows, showWeeks, curWeek, p.key, shutCnt, totCap, months)
          + '</div></div>';
  });

  document.getElementById('sections').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë‹¤í¬ í…Œì´ë¸” ë¹Œë” (í™”ë©´ UIìš©)
// ì»¬ëŸ¼: Company | Country | Cap | W1..Wn
// table-layout:fixed + colgroupìœ¼ë¡œ ì—´ ë„ˆë¹„ ê· ì¼ ê³ ì •
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDarkTable(rows, showWeeks, curWeek, prodKey, shutCnt, totCap, months) {
  var monthGroups = groupByMonth(showWeeks);
  // ê¸°ë³¸ì •ë³´ ì»¬ëŸ¼: Company(ê³ ì •) + Country + Cap = 3ì—´
  var nInfo = 3;

  var h = '<table class="cal-tbl">'
        + '<colgroup>'
        + '<col class="col-co">'   // Company ì—´ 140px ê³ ì •
        + '<col class="col-loc">'  // Country ì—´ 60px ê³ ì •
        + '<col class="col-cap">'  // Cap ì—´ 36px ê³ ì •
        + '</colgroup>'
        + '<thead>';

  // â”€â”€ í–‰1: ê¸°ë³¸ì •ë³´ í—¤ë”(rowspan=2) + ì›” í—¤ë” (Lossë¥¼ ì›” í…ìŠ¤íŠ¸ ì•ˆì— ì¸ë¼ì¸ í‘œì‹œ) â”€â”€
  h += '<tr>';
  // ê¸°ë³¸ì •ë³´ (rowspan=2)
  h += '<th class="th-info" colspan="' + nInfo + '" rowspan="2" style="white-space:nowrap;font-size:10px;">'
     + '<span style="color:#fff;font-weight:700;font-size:11px;">' + prodKey + '</span>'
     + ' <span style="color:#AED6F1;font-weight:400;font-size:9px;">ì •ì§€ ' + shutCnt + 'ê°œ ì„¤ë¹„</span></th>';

  // ì›” í—¤ë”: colspan = ì£¼ì°¨ìˆ˜ë§Œ, í…ìŠ¤íŠ¸ì— Loss ì¸ë¼ì¸ í¬í•¨
  monthGroups.forEach(function(mg) {
    var bg       = M_XL[mg.m] || '#f0f4f8';
    var mLossKt  = rows.reduce(function(s,r){ return s + calcRowLoss(r, mg.m); }, 0);
    var mLossRate= totCap > 0 ? (mLossKt / totCap * 100).toFixed(1) : '0.0';
    var lossInfo = mLossKt > 0
      ? '<br><span style="color:#1a252f;font-size:10px;font-weight:700;">' + mLossKt.toFixed(0) + 'kt / ' + mLossRate + '%</span>'
      : '';
    h += '<th class="th-mon" colspan="' + mg.wks.length + '" style="background:' + bg + ';color:#1a252f;padding:5px 2px;font-size:10px;">'
       + MN[mg.m-1] + lossInfo + '</th>';
  });
  h += '</tr>';

  // â”€â”€ í–‰2: ì£¼ì°¨ í—¤ë”ë§Œ (Loss ë³„ë„ ì—´ ì—†ìŒ) â”€â”€
  h += '<tr>';
  showWeeks.forEach(function(wk) {
    var ic = wk.week === curWeek;
    var bg = M_XL[wk.month] || '#f4f6f7';
    h += '<th class="th-wk' + (ic?' cur-wk-th':'') + '" style="background:' + bg + ';color:#444;"'
       + ' title="W' + wk.week + ': ' + wk.ms + '~' + wk.ss + '">'
       + 'W' + wk.week + '<br><span style="font-size:7px;">' + wk.sd + '</span></th>';
  });
  h += '</tr></thead><tbody>';

  if (!rows.length) {
    var totalCols = nInfo + showWeeks.length;
    h += '<tr><td colspan="' + totalCols + '" style="text-align:center;padding:14px;color:#4a6a88;font-size:10px;">ë°ì´í„° ì—†ìŒ</td></tr>';
    h += '</tbody></table>';
    return h;
  }

  // â”€â”€ ë°ì´í„° í–‰ (Country ê·¸ë£¹ í—¤ë” ì œê±°, Country ì»¬ëŸ¼ í‘œì‹œ) â”€â”€
  var ri_global = 0;
  groupByCountry(rows).forEach(function(g) {
    g.rows.forEach(function(r, ri) {
      var tc = ri_global%2===0 ? 'tr-e' : 'tr-o';
      ri_global++;
      h += '<tr class="' + tc + '">';
      h += '<td class="td-co" title="' + esc(r.company) + '">' + esc(r.company) + '</td>';
      h += '<td class="td-loc">' + esc(g.country||'') + '</td>';
      h += '<td class="td-cap">' + (r.capacity ? Math.round(r.capacity) : 'â€”') + '</td>';

      // ì£¼ì°¨ ì…€ë§Œ (LossëŠ” ì›” í—¤ë”ì— ì¸ë¼ì¸ í‘œì‹œ)
      showWeeks.forEach(function(wk) {
        var c  = r.weekColors ? r.weekColors[wk.idx] : null;
        var ic = wk.week === curWeek;
        h += '<td class="td-wk" style="'
           + (c ? 'background:' + c + ';' : '')
           + (ic ? 'border-left:2px solid #f39c12;border-right:2px solid #f39c12;' : '')
           + '"></td>';
      });
      h += '</tr>';
    });
  });

  h += '</tbody></table>';
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [ìˆ˜ì •1] PNG ì €ì¥ - A4 ê°€ë¡œ ê³ ì • (297Ã—210mm)
// --------------------------------------------------
// A4 ê°€ë¡œ @150dpi = 1754 Ã— 1240 px
// html2canvas scale=2 â†’ ìµœì¢… PNG = 3508 Ã— 2480 px (300dpi í’ˆì§ˆ)
//
// í•µì‹¬ ë³€ê²½:
//   - heightë¥¼ scrollHeight ëŒ€ì‹  A4_H(1240px) ê³ ì •ìœ¼ë¡œ ë³€ê²½
//   - buildXLAll() í˜¸ì¶œ ì‹œ A4_H ì „ë‹¬ â†’ ë‚´ë¶€ì—ì„œ í–‰ ë†’ì´ ìë™ ì••ì¶•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadPNG() {
  var months    = getSelMonths();
  var showWeeks = months.length > 0
    ? weekMeta.filter(function(w){ return months.indexOf(w.month) !== -1; })
    : weekMeta;
  var curWeek = getCurWeek();
  var today   = new Date();
  var ds      = today.getFullYear() + ('0'+(today.getMonth()+1)).slice(-2) + ('0'+today.getDate()).slice(-2);
  var mLbl    = months.length === 0 ? 'ALL' : months.map(function(m){ return MN[m-1]; }).join('-');
  var fname   = 'NEA_Shutdown_' + mLbl + '_' + ds + '.png';

  var btn = document.getElementById('btn-png');
  btn.disabled = true; btn.textContent = 'â³ ìƒì„± ì¤‘...';

  // A4 ê°€ë¡œ ê³ ì • ì¹˜ìˆ˜ (150dpi ê¸°ì¤€, scale=2 ì ìš© ì‹œ 300dpi í’ˆì§ˆ)
  var A4_W = 1754; // A4 ê°€ë¡œ px (150dpi)
  var A4_H = 1240; // A4 ì„¸ë¡œ px (150dpi) â† ê³ ì •ê°’

  var clone = document.getElementById('xl-clone');
  // A4_Hë¥¼ buildXLAllì— ì „ë‹¬ â†’ í…Œì´ë¸” í–‰ ë†’ì´ ì••ì¶• ê³„ì‚°ì— í™œìš©
  clone.innerHTML = buildXLAll(showWeeks, curWeek, months, ds, A4_W, A4_H);

  requestAnimationFrame(function(){
    requestAnimationFrame(function(){
      var target = document.getElementById('xl-wrap');

      html2canvas(target, {
        backgroundColor: '#ffffff',
        scale: 2,           // 150dpi â†’ 300dpi ì—…ìŠ¤ì¼€ì¼ (PPT ê³ í™”ì§ˆ)
        useCORS: true,
        logging: false,
        scrollX: 0, scrollY: 0,
        width:  A4_W,       // A4 ê°€ë¡œ ê³ ì •
        height: A4_H        // [ìˆ˜ì •] A4 ì„¸ë¡œ ê³ ì • (scrollHeight â†’ ê³ ì •ê°’)
      }).then(function(canvas) {
        clone.innerHTML = '';
        btn.disabled = false; btn.textContent = 'ğŸ“· PNG ì €ì¥';

        if (isIOS) {
          var w = window.open('', '_blank');
          if (w) {
            w.document.write('<html><body style="margin:0;padding:8px;background:#eee;">'
              + '<p style="font:11px Arial;color:#555;margin-bottom:5px;">ğŸ“± ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥ (' + fname + ')</p>'
              + '<img src="' + canvas.toDataURL('image/png') + '" style="width:100%;border:1px solid #ccc;"></body></html>');
            w.document.close();
          }
          showToast('ğŸ“± ìƒˆ íƒ­ì—ì„œ ì´ë¯¸ì§€ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥', 'warn', 4000);
        } else {
          canvas.toBlob(function(blob){
            var url = URL.createObjectURL(blob);
            var a   = document.createElement('a');
            a.href = url; a.download = fname;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            setTimeout(function(){ URL.revokeObjectURL(url); }, 3000);
            showToast('âœ… ì €ì¥ ì™„ë£Œ: ' + fname, 'ok', 3000);
          }, 'image/png');
        }
      }).catch(function(e){
        clone.innerHTML = '';
        btn.disabled = false; btn.textContent = 'ğŸ“· PNG ì €ì¥';
        showToast('âŒ ì‹¤íŒ¨: ' + e.message, 'err', 4000);
      });
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [ìˆ˜ì •1 + ìˆ˜ì •2] PNG ìº¡ì²˜ ì „ìš© í…Œì´ë¸” ë¹Œë”
// --------------------------------------------------
// [ìˆ˜ì •1] A4 ê³ ì • ë†’ì´ì— ë§ì¶° í–‰ ë†’ì´ ìë™ ì••ì¶•
//   - íƒ€ì´í‹€ í–‰(20px) + ë²”ë¡€ í–‰(20px) + í’ˆëª©ë³„ í—¤ë” 2í–‰ ì œì™¸
//   - ë‚¨ì€ ë†’ì´ / ì „ì²´ ë°ì´í„° í–‰ ìˆ˜ â†’ í–‰ ë†’ì´ ì—­ì‚° (ìµœì†Œ 12px)
//
// [ìˆ˜ì •2] table-layout:fixed + colgroupìœ¼ë¡œ ì—´ ë„ˆë¹„ ê· ì¼ ê³ ì •
//   - ê¸°ì¡´ table-layout:auto â†’ fixed ë³€ê²½
//   - Company(coW) / Country(locW) / Cap(capW) ì—´ ë„ˆë¹„ ëª…ì‹œì  ê³ ì •
//   - ëª¨ë“  í’ˆëª© í…Œì´ë¸”ì´ ë™ì¼í•œ ì—´ êµ¬ì¡°ë¥¼ ê°€ì§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildXLAll(showWeeks, curWeek, months, ds, A4_W, A4_H) {
  var mLbl  = months.length === 0 ? 'All Months' : months.map(function(m){ return MN[m-1]; }).join(' Â· ');
  var today = ds.slice(0,4) + '.' + ds.slice(4,6) + '.' + ds.slice(6);
  var nI    = 3; // Company / Location / Cap ì—´ ìˆ˜
  var bd    = 'border:1px solid #CCD1D1;';  // ì¼ë°˜ ì…€ í…Œë‘ë¦¬
  var bd2   = 'border:1px solid #5D6D7E;';  // í—¤ë” í…Œë‘ë¦¬
  var monthGroups = groupByMonth(showWeeks);
  var totalCols   = nI + showWeeks.length;

  // â”€â”€ [ìˆ˜ì •2] ê³ ì • ì—´ ë„ˆë¹„ ì •ì˜ â”€â”€
  // ëª¨ë“  í’ˆëª© í…Œì´ë¸”ì— ë™ì¼í•˜ê²Œ ì ìš© â†’ ì—´ ì •ë ¬ ê· ì¼ ë³´ì¥
  var coW  = 110; // Company ì—´ ê³ ì • ë„ˆë¹„(px)
  var locW = 55;  // Country ì—´ ê³ ì • ë„ˆë¹„(px)
  var capW = 32;  // Cap ì—´ ê³ ì • ë„ˆë¹„(px)
  var infoW = coW + locW + capW; // ê¸°ë³¸ì •ë³´ ì—´ ì´ ë„ˆë¹„ = 197px

  // â”€â”€ [ìˆ˜ì •1] ì£¼ì°¨ ì…€ ë„ˆë¹„ ì—­ì‚° â”€â”€
  // ë‚¨ì€ ê°€ë¡œ ê³µê°„ì„ ì£¼ì°¨ ìˆ˜ë¡œ ê· ë“± ë¶„í•  (ìµœì†Œ 12px, ìµœëŒ€ 30px)
  var wkW = showWeeks.length > 0
    ? Math.min(30, Math.max(12, Math.floor((A4_W - infoW) / showWeeks.length)))
    : 24;

  // â”€â”€ [ìˆ˜ì •1] í–‰ ë†’ì´ ì—­ì‚° â”€â”€
  // A4 ì „ì²´ ë†’ì´ì—ì„œ ê³ ì • ì˜ì—­(íƒ€ì´í‹€+ë²”ë¡€+í—¤ë”) ì œì™¸ í›„ ë°ì´í„° í–‰ ìˆ˜ë¡œ ë‚˜ëˆ”
  var TITLE_H  = 22; // ë©”ì¸ íƒ€ì´í‹€ í–‰ ë†’ì´(px)
  var LEGEND_H = 22; // ë²”ë¡€ í–‰ ë†’ì´(px)
  var HDR1_H   = 26; // í’ˆëª©ë³„ ì›” í—¤ë” í–‰ ë†’ì´(px)
  var HDR2_H   = 18; // í’ˆëª©ë³„ ì£¼ì°¨ í—¤ë” í–‰ ë†’ì´(px)
  var PROD_GAP = 4;  // í’ˆëª© ê°„ê²©(px)

  // ì „ì²´ ë°ì´í„° í–‰ ìˆ˜ ê³„ì‚° (ëª¨ë“  í’ˆëª© í•©ì‚°)
  var totalDataRows = PRODS.reduce(function(sum, p) {
    return sum + filterRows(allData[p.key] || [], months).length;
  }, 0);
  if (totalDataRows === 0) totalDataRows = 1; // 0ë‚˜ëˆ” ë°©ì§€

  // ê³ ì • ì˜ì—­ ì´ ë†’ì´ = íƒ€ì´í‹€ + ë²”ë¡€ + (í—¤ë”2í–‰ Ã— í’ˆëª©ìˆ˜) + (í’ˆëª©ê°„ê²© Ã— í’ˆëª©ìˆ˜)
  var fixedH = TITLE_H + LEGEND_H
             + (HDR1_H + HDR2_H + PROD_GAP) * PRODS.length;

  // ë°ì´í„° í–‰ 1ê°œë‹¹ ë†’ì´ ì—­ì‚° (ìµœì†Œ 12px ë³´ì¥)
  var rowH = Math.max(12, Math.floor((A4_H - fixedH) / totalDataRows));

  // í°íŠ¸ í¬ê¸°ë„ í–‰ ë†’ì´ì— ë¹„ë¡€ ì¡°ì • (ìµœì†Œ 7px, ìµœëŒ€ 10px)
  var fSize = Math.min(10, Math.max(7, rowH - 4));

  // â”€â”€ ì „ì²´ ë˜í¼ div â”€â”€
  var h = '<div id="xl-wrap" style="display:block;background:#fff;'
        + 'font-family:Arial,sans-serif;font-size:' + fSize + 'px;'
        + 'width:' + A4_W + 'px;height:' + A4_H + 'px;'  // A4 ê³ ì • í¬ê¸° ëª…ì‹œ
        + 'box-sizing:border-box;overflow:hidden;">';       // ë„˜ì¹¨ ìˆ¨ê¹€ ì²˜ë¦¬

  // â”€â”€ ë©”ì¸ íƒ€ì´í‹€ â”€â”€
  h += '<table style="border-collapse:collapse;width:100%;">';
  h += '<tr><td colspan="' + totalCols + '" style="background:#1B2631;color:#fff;'
     + 'font-size:12px;font-weight:700;padding:4px 12px;height:' + TITLE_H + 'px;' + bd2 + '">'
     + '&nbsp;ğŸ­&nbsp; NEA Plant Shutdown Calendar ' + YEAR
     + '&nbsp;&nbsp;<span style="font-size:9px;color:#AEB6BF;font-weight:400;">'
     + mLbl + '&nbsp;|&nbsp;' + today + ' ê¸°ì¤€</span></td></tr>';
  h += '</table>';

  // â”€â”€ í’ˆëª©ë³„ í…Œì´ë¸” (SM / AN / BD / BPA / MMA) â”€â”€
  PRODS.forEach(function(prod, pi) {
    var rows    = filterRows(allData[prod.key] || [], months);
    var shutCnt = rows.filter(function(r){ return r.weekColors&&r.weekColors.some(Boolean); }).length;
    var totCap  = (allData[prod.key]||[]).reduce(function(s,r){return s+(r.capacity||0);},0);

    // [ìˆ˜ì •2] table-layout:fixed ì ìš© + colgroupìœ¼ë¡œ ì—´ ë„ˆë¹„ ëª…ì‹œ ê³ ì •
    // â†’ auto ëª¨ë“œì—ì„œ ì…€ ë‚´ìš© ê¸¸ì´ì— ë”°ë¼ ì—´ ë„ˆë¹„ê°€ ë‹¬ë¼ì§€ë˜ ë¬¸ì œ í•´ê²°
    h += '<table style="border-collapse:collapse;width:100%;'
       + 'table-layout:fixed;'  // [ìˆ˜ì •2 í•µì‹¬] auto â†’ fixed ë³€ê²½
       + 'margin-top:' + (pi===0?'0':PROD_GAP+'px') + ';">';

    // [ìˆ˜ì •2] colgroupìœ¼ë¡œ ê¸°ë³¸ì •ë³´ ì—´ 3ê°œ ë„ˆë¹„ ëª…ì‹œ ê³ ì •
    // ì£¼ì°¨ ì—´ì€ wkWë¡œ ê· ë“± ê³ ì •
    h += '<colgroup>';
    h += '<col style="width:' + coW  + 'px;">'; // Company ì—´ ê³ ì •
    h += '<col style="width:' + locW + 'px;">'; // Country ì—´ ê³ ì •
    h += '<col style="width:' + capW + 'px;">'; // Cap ì—´ ê³ ì •
    // ì£¼ì°¨ ì…€ colgroup (wkWë¡œ ê· ë“± ë¶„í• )
    showWeeks.forEach(function() {
      h += '<col style="width:' + wkW + 'px;">';
    });
    h += '</colgroup>';

    // â”€â”€ í–‰1: í’ˆëª© í—¤ë”(rowspan=2) + ì›” í—¤ë” (Loss ì¸ë¼ì¸) â”€â”€
    h += '<tr style="height:' + HDR1_H + 'px;">';
    h += '<td colspan="' + nI + '" rowspan="2" style="background:' + prod.hdColor + ';color:#fff;'
       + 'font-weight:700;font-size:10px;text-align:center;vertical-align:middle;'
       + 'padding:3px 5px;' + bd + 'white-space:nowrap;">'
       + prod.key
       + '<br><span style="font-size:8px;font-weight:400;color:#AED6F1;">'
       + 'ì •ì§€ ' + shutCnt + 'ê°œ | NEA ' + (allData[prod.key]||[]).length + 'ê°œ</span></td>';

    // ì›” í—¤ë”: colspan=ì£¼ì°¨ìˆ˜, Loss ì¸ë¼ì¸
    monthGroups.forEach(function(mg) {
      var bg       = M_XL[mg.m] || '#f0f4f8';
      var mLossKt  = rows.reduce(function(s,r){ return s + calcRowLoss(r, mg.m); }, 0);
      var mLossRate= totCap > 0 ? (mLossKt / totCap * 100).toFixed(1) : '0.0';
      var lossInfo = mLossKt > 0
        ? '<br><span style="color:#1a252f;font-size:9px;font-weight:700;">' + mLossKt.toFixed(0) + 'kt / ' + mLossRate + '%</span>'
        : '';
      h += '<td colspan="' + mg.wks.length + '" style="background:' + bg + ';color:#1a252f;'
         + 'font-weight:700;font-size:10px;text-align:center;padding:3px 2px;line-height:1.3;' + bd + '">'
         + MN[mg.m-1] + lossInfo + '</td>';
    });
    h += '</tr>';

    // â”€â”€ í–‰2: ì£¼ì°¨ í—¤ë” â”€â”€
    h += '<tr style="height:' + HDR2_H + 'px;">';
    showWeeks.forEach(function(wk) {
      var bg  = M_XL[wk.month] || '#f0f4f8';
      var ic  = wk.week === curWeek;
      var cbg = ic ? '#FEF9E7' : bg;
      var brd = ic ? 'border-left:2px solid #E67E22;border-right:2px solid #E67E22;' : bd;
      h += '<td style="background:' + cbg + ';' + brd + 'font-weight:700;font-size:7px;'
         + 'text-align:center;padding:1px;white-space:nowrap;line-height:1.2;vertical-align:middle;">'
         + 'W' + wk.week + '<br><span style="font-size:6px;color:#7f8c8d;">' + wk.sd + '</span></td>';
    });
    h += '</tr>';

    // â”€â”€ ë°ì´í„° ì—†ìŒ ì²˜ë¦¬ â”€â”€
    if (!rows.length) {
      h += '<tr style="height:' + rowH + 'px;"><td colspan="' + totalCols
         + '" style="text-align:center;padding:4px;color:#888;font-size:9px;">ë°ì´í„° ì—†ìŒ</td></tr>';
      h += '</table>';
      return;
    }

    // â”€â”€ ë°ì´í„° í–‰ â”€â”€
    // rowH: A4 ê³ ì • ë†’ì´ì—ì„œ ì—­ì‚°ëœ í–‰ ë†’ì´ ì ìš© â†’ í•œ í˜ì´ì§€ì— ë§ì¶¤
    var ri_g = 0;
    groupByCountry(rows).forEach(function(g) {
      g.rows.forEach(function(r) {
        var rb = ri_g%2===0 ? '#F2F3F4' : '#FFFFFF'; // ì§ìˆ˜/í™€ìˆ˜ í–‰ ë°°ê²½
        var co = ri_g%2===0 ? '#EBF5FB' : '#F8FAFB'; // Company ì—´ ë°°ê²½
        ri_g++;
        h += '<tr style="height:' + rowH + 'px;">';

        // Company ì—´ - [ìˆ˜ì •2] width:coW ëª…ì‹œ (auto ë°©ì§€)
        h += '<td style="background:' + co + ';color:#1a252f;font-weight:600;font-size:' + fSize + 'px;'
           + 'padding:1px 4px;' + bd + 'width:' + coW + 'px;'
           + 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'
           + esc(r.company) + '</td>';

        // Country ì—´ - [ìˆ˜ì •2] width:locW ëª…ì‹œ
        h += '<td style="background:' + rb + ';font-size:' + (fSize-1) + 'px;color:#555;'
           + 'padding:1px 3px;' + bd + 'width:' + locW + 'px;'
           + 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'
           + esc(g.country||'') + '</td>';

        // Cap ì—´ - [ìˆ˜ì •2] width:capW ëª…ì‹œ
        h += '<td style="background:' + rb + ';text-align:right;font-weight:700;'
           + 'color:#117A65;font-size:' + fSize + 'px;'
           + 'padding:1px 3px;' + bd + 'width:' + capW + 'px;white-space:nowrap;">'
           + (r.capacity ? Math.round(r.capacity) : '') + '</td>';

        // ì£¼ì°¨ ì…€ - [ìˆ˜ì •2] width:wkW ëª…ì‹œ
        showWeeks.forEach(function(wk) {
          var c   = r.weekColors ? r.weekColors[wk.idx] : null;
          var ic  = wk.week === curWeek;
          var bg  = c ? c : rb;
          var brd = ic ? 'border-left:2px solid #E67E22;border-right:2px solid #E67E22;' : bd;
          h += '<td style="background:' + bg + ';' + brd
             + 'width:' + wkW + 'px;text-align:center;padding:0;"></td>';
        });
        h += '</tr>';
      });
    });

    h += '</table>';
  });

  // â”€â”€ ë²”ë¡€ â”€â”€
  h += '<table style="border-collapse:collapse;width:100%;margin-top:2px;">';
  h += '<tr style="height:' + LEGEND_H + 'px;">'
     + '<td style="background:#F8F9FA;border-top:2px solid #BDC3C7;padding:3px 12px;">'
     + '<span style="font-size:8px;color:#555;margin-right:8px;">ë²”ë¡€:</span>'
     + dot('#F1C40F') + '<span style="font-size:8px;color:#555;margin-right:10px;">ì •ê¸°ë³´ìˆ˜</span>'
     + dot('#E74C3C') + '<span style="font-size:8px;color:#555;margin-right:10px;">ê¸´ê¸‰/ë¹„ê³„íš ì •ì§€</span>'
     + dot('#3498DB') + '<span style="font-size:8px;color:#555;margin-right:14px;">ì˜ˆì • ë³´ìˆ˜</span>'
     + '<span style="font-size:8px;color:#7D6608;">Loss% = NEA ì „ì²´ Capacity ëŒ€ë¹„ (Loss kt / NEA Cap Ã— 100)</span>'
     + '</td></tr></table>';

  h += '</div>';
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸: ë²”ë¡€ ìƒ‰ìƒ ì 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dot(c) {
  return '<span style="display:inline-block;width:9px;height:9px;background:' + c
       + ';border-radius:2px;vertical-align:middle;margin-right:3px;"></span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Loss ê³„ì‚°
// Loss(kt) = Capacity(kt/y) Ã— í•´ë‹¹ì›” ì •ì§€ì¼ìˆ˜ / 30 (ì›”ê°„ 30ì¼ ê¸°ì¤€)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRowLoss(row, month) {
  if (!row.weekColors || !row.capacity) return 0;
  // í•´ë‹¹ ì›”ì— ì†í•˜ëŠ” ì£¼ì°¨ë“¤
  var mwks = weekMeta.filter(function(w){ return w.month === month; });
  var shutDays = 0;
  mwks.forEach(function(wk) {
    if (row.weekColors[wk.idx]) {
      var mon    = wk.monday;
      var sun    = wk.sunday;
      var mStart = new Date(YEAR, month-1, 1);
      var mEnd   = new Date(YEAR, month, 0); // ì›” ë§ì¼
      var os = mon > mStart ? mon : mStart;
      var oe = sun < mEnd   ? sun : mEnd;
      if (os <= oe) {
        shutDays += (oe - os) / 86400000 + 1;
      }
    }
  });
  return row.capacity * shutDays / 30;
}

function calcTotalLoss(rows, months) {
  var total = 0;
  rows.forEach(function(r) {
    months.forEach(function(m) { total += calcRowLoss(r, m); });
  });
  return total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸ í•¨ìˆ˜ë“¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function filterRows(rows, months) {
  return rows.filter(function(r) {
    if (viewMode === 'shutdown') {
      if (!r.weekColors || !r.weekColors.some(Boolean)) return false;
    }
    if (months && months.length > 0) {
      var mw  = weekMeta.filter(function(w){ return months.indexOf(w.month) !== -1; });
      var hit = mw.some(function(w){ return r.weekColors && r.weekColors[w.idx]; });
      if (!hit && viewMode === 'shutdown') return false;
    }
    return true;
  });
}

function scrollCurWeek() {
  var el = document.querySelector('.cur-wk-th');
  if (el) el.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
}

function showToast(msg, type, ms) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = 'show ' + (type==='ok'?'':type==='warn'?'warn':'err');
  clearTimeout(t._t);
  t._t = setTimeout(function(){ t.className=''; }, ms||3000);
}

function buildWeekMeta() {
  var meta = [];
  for (var w = 1; w <= 52; w++) {
    var mon = isoMon(YEAR, w);
    var sun = new Date(mon); sun.setDate(mon.getDate()+6);
    var mid = new Date(mon); mid.setDate(mon.getDate()+3);
    meta.push({
      idx:w-1, week:w, month:mid.getMonth()+1,
      monday:mon, sunday:sun,
      ms:fd(mon), ss:fd(sun), sd:(mon.getMonth()+1)+'/'+mon.getDate()
    });
  }
  return meta;
}

function isoMon(yr, w) {
  var j4=new Date(yr,0,4), d=j4.getDay()||7;
  var w1=new Date(j4); w1.setDate(j4.getDate()-(d-1));
  var m=new Date(w1); m.setDate(w1.getDate()+(w-1)*7);
  return m;
}

function getCurWeek() {
  var t = new Date();
  for (var i=0;i<weekMeta.length;i++) {
    if (t>=weekMeta[i].monday&&t<=weekMeta[i].sunday) return weekMeta[i].week;
  }
  return -1;
}

function fd(d) { return (d.getMonth()+1)+'/'+d.getDate(); }

function groupByMonth(wks) {
  var g=[], cur=null;
  wks.forEach(function(w){
    if (!cur||cur.m!==w.month){ cur={m:w.month,wks:[]}; g.push(cur); }
    cur.wks.push(w);
  });
  return g;
}

function groupByCountry(rows) {
  var idx={}, g=[];
  rows.forEach(function(r){
    var k=r.country||'Unknown';
    if(idx[k]===undefined){idx[k]=g.length;g.push({country:k,rows:[]});}
    g[idx[k]].rows.push(r);
  });
  return g;
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function stClrDk(s) {
  if (!s) return '#607a90'; s=s.toLowerCase();
  if (s.indexOf('future')!=-1)      return '#2980B9';
  if (s.indexOf('maintenance')!=-1) return '#c8a000';
  if (s.indexOf('shutdown')!=-1)    return '#c0392b';
  return '#607a90';
}
</script>
</body>
</html>
